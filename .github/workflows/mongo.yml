name: Mongo CI/CD

on:
  push:
    branches:
      - main
    paths:
      - mongo/**
      - docker-compose.yml

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Validate Mongo container
        run: |
          docker run -d --name mongo-test -p 27017:27017 mongo:7
          sleep 5
          docker exec mongo-test mongosh --eval "db.stats()"
          docker rm -f mongo-test

  deploy:
    needs: validate
    runs-on: self-hosted
    
    env:
      PROD_DIR: C:\Production\MAL3020-Full-Stack-Development
    
    steps:
      - name: Create production directory if not exists
        run: |
          if (!(Test-Path "${{ env.PROD_DIR }}")) {
            New-Item -ItemType Directory -Path "${{ env.PROD_DIR }}" -Force
          }
        shell: pwsh
      
      - name: Clone/Pull latest code to production
        run: |
          cd C:\Production
          if (Test-Path "${{ env.PROD_DIR }}\.git") {
            cd "${{ env.PROD_DIR }}"
            git pull origin main
          } else {
            git clone https://github.com/TanggaPendek/MAL3020-Full-Stack-Development.git
          }
        shell: pwsh
      
      - name: Deploy with docker-compose
        run: |
          cd "${{ env.PROD_DIR }}"
          docker-compose down
          docker-compose up -d --build
        shell: pwsh
      
      - name: Show deployment status
        run: |
          cd "${{ env.PROD_DIR }}"
          docker-compose ps
          Write-Host "`nMongo deployed: localhost:27017" -ForegroundColor Green
        shell: pwsh
